@page "/Conflicts"

@using TranslateWebApp.Interfaces

@inject ILogger<ConflictPage> logger
@inject IDataContext data
@inject IStatusMessage statusMessageQuery
@inject IApplicationUser appUser
@inject IApplicationState appState

<PageTitle>Conflicts</PageTitle>

<MenuBar />

<AuthorizeView>
    <Authorized>

        <div class="card shadow mt-2">
            <div class="card-header">
                <span>Conflict Resolution</span>
                <span style="float:right;">Welcome: <b>@appUser.FirstName</b></span>
            </div>
            <div class="card-body">
                <div class="m-1">
                    @if (data.UserProjects.Count > 0)
                    {
                        <div>
                            Choose your project and language.
                        </div>
                    }
                    else
                    {
                        <div>Click the <b>Start Working</b> button to find translation conflicts in your projects.</div>
                        <div class="text-center mt-2">
                            <button class="btn btn-lg btn-success" @onclick="@(() => ClickStart())">Start Working</button>
                        </div>
                    }
                </div>
                <ProjectControl OnClick="RunQuery" />
                <LanguageControl OnClick="RunQuery" ShowHelper=false />
            </div>

            @if (!statusMessageQuery.IsEmpty)
            {
                <div class="card-footer p-3">
                    <StatusBox StatusMessage="statusMessageQuery" />
                </div>
            }

        </div>

        @if (!QueryIsRunning)
        {
            if (appState.Conflicts != null && appState.Conflicts.Items.Count > 0)
            {
                <ConflictListControl ShowNumbers="@ShowNumbers" OnPick="HandleOnPick" />
            }
            if (currentConflict != null && currentConflict.CandidatesLeft > 0)
            {
                <AlternativeTranslationsControl Conflict="@currentConflict" ShowNumbers="@ShowNumbers" OnPickFirst="PickFirst" />
            }
        }

    </Authorized>
</AuthorizeView>


@code {
    [CascadingParameter]
    public required Task<AuthenticationState> AuthStateTask { get; set; }

    #region Private Fields  

    private TextConflict? currentConflict;
    private bool QueryIsRunning = false;
    private bool ShowNumbers = false;

    #endregion

    private async Task ClickStart()
    {
        await RunQuery();
    }

    private void HandleOnPick(TextConflict conflict)
    {
        currentConflict = conflict;
        StateHasChanged();
    }

    private void PickFirst()
    {
        if (appState.Conflicts.Items.Count > 0)
        {
            currentConflict = appState.Conflicts.Items[0];
            statusMessageQuery.SetInformation("Workload", $"There are {appState.Conflicts.Items.Count} more conflicts to resolve.");
        }
        else
        {
            statusMessageQuery.SetSuccess("No more conflicts", "There are no translation conflicts for the selected project and language");
            currentConflict = null;
        }
    }

    private async Task RunQuery()
    {
        if (!appUser.Authenticated || QueryIsRunning) return;
        try
        {
            statusMessageQuery.SetInformation("Please Wait", "Retrieving a list of conflicts for you to resolve.  Please wait for this message to disappear. It may take several seconds.");
            QueryIsRunning = true;
            await data.LoadConflicts(appUser.LogTo);
            PickFirst();
        }
        catch (Exception e)
        {
            statusMessageQuery.SetException(e);
        }
        QueryIsRunning = false;
        StateHasChanged();
    }

}
